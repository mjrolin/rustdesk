name: Build RustDesk for Windows

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        echo "C:\Users\runneradmin\.cargo\bin" >> $GITHUB_PATH

    - name: Install Visual Studio Build Tools
      run: |
        choco install -y visualstudio2019buildtools --package-parameters "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 --add Microsoft.VisualStudio.Component.Windows10SDK"

    - name: Install VCPKG
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        cd vcpkg
        git checkout 2023.10.19
        .\bootstrap-vcpkg.bat -disableMetrics
        cd ..
        echo "VCPKG_ROOT=C:\vcpkg" >> $GITHUB_ENV
        echo "C:\vcpkg" >> $GITHUB_PATH

    - name: Verify VCPKG installation
      run: |
        dir C:\vcpkg
        .\vcpkg\vcpkg version

    - name: Clear VCPKG cache
      run: |
        Remove-Item -Recurse -Force C:\vcpkg\buildtrees -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force C:\vcpkg\packages -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force C:\vcpkg\installed -ErrorAction SilentlyContinue

    - name: Install libvpx
      run: |
        .\vcpkg\vcpkg install libvpx:x64-windows-static --debug --clean-after-build
        dir C:\vcpkg\installed\x64-windows-static\include
        dir C:\vcpkg\installed\x64-windows-static\lib

    - name: Install libyuv
      run: |
        .\vcpkg\vcpkg install libyuv:x64-windows-static --debug --clean-after-build
        dir C:\vcpkg\installed\x64-windows-static\include
        dir C:\vcpkg\installed\x64-windows-static\lib

    - name: Install opus
      run: |
        .\vcpkg\vcpkg install opus:x64-windows-static --debug --clean-after-build
        dir C:\vcpkg\installed\x64-windows-static\include
        dir C:\vcpkg\installed\x64-windows-static\lib

    - name: Integrate VCPKG
      run: |
        .\vcpkg\vcpkg integrate install

    - name: Verify VCPKG installation
      run: |
        dir C:\vcpkg\installed
        dir C:\vcpkg\installed\x64-windows-static
        dir C:\vcpkg\installed\x64-windows-static\include
        dir C:\vcpkg\installed\x64-windows-static\include\opus
        dir C:\vcpkg\installed\x64-windows-static\lib

    - name: Build RustDesk
      env:
        VCPKG_ROOT: C:\vcpkg
      run: cargo build --release

    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-windows
        path: target/release/rustdesk.exe